<?xml version="1.0" encoding="UTF-8"?>

<mule 
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns="http://www.mulesoft.org/schema/mule/core"  
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:spring="http://www.mulesoft.org/schema/mule/spring"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"	
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:sap="http://www.mulesoft.org/schema/mule/sap"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/spring http://www.mulesoft.org/schema/mule/spring/current/mule-spring.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd
http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-current.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/sap http://www.mulesoft.org/schema/mule/sap/current/mule-sap.xsd">

	<import doc:name="common-general" file="common-general.xml" />
	<import doc:name="common-general-email" file="common-general-email.xml" />
	<import doc:name="common-was" file="common-was.xml" />
	<import doc:name="common-activemq" file="common-activemq.xml" />
	<import doc:name="common-as400" file="common-as400.xml" />

	<!-- formerly known as mule-apps.properties - principle does not exist anymore -->
	<configuration-properties
		doc:name="Configuration properties"
		doc:id="9b0bbc32-048a-4b22-baf0-a4ca0e6d9650" file="config.yaml" />
		
	<import doc:name="common-general" file="common-general.xml" />

	<configuration-properties
		file="hvac-unneeded-material-app-${common-general.env}.yaml"
		doc:name="Spring Property Placeholders"
		doc:id="a7b12f13-e52b-4876-b631-3cfdead31190" />

	<secure-properties:config
		key="${common-general.credentials.key}" file="credentials-hvac-unneeded-material-app-${common-general.env}.yaml"
		name="hvac-unneeded-material-app-Secure_Property_Placeholder">
		<secure-properties:encrypt algorithm="AES"
			mode="CBC" />
	</secure-properties:config>

	<wsc:config name="RohrisometrieBean_Config" doc:name="Web Service Consumer Config" doc:id="72f1873d-e174-4850-b781-471cdeb8ece9" >
		<wsc:connection wsdlLocation="api\RohrisometrieBeanService.wsdl" service="RohrisometrieBeanService" port="RohrisometrieBeanPort" address="${common-was.endpoint}/Entwicklung_Fertigung_EJBServices_Web/RohrisometrieBeanService" >
			<wsc:custom-transport-configuration >
				<wsc:http-transport-configuration requesterConfig="common-was-http-request-configuration" />
			</wsc:custom-transport-configuration>
			<wsc:web-service-security actor="http://schemas.xmlsoap.org/soap/actor/next" >
				<wsc:username-token-security-strategy username="${was.username}" password="${secure::was.password}" addNonce="true" addCreated="true" />
			</wsc:web-service-security>
		</wsc:connection>
	</wsc:config>
	<wsc:config name="BestellungBean_Config" doc:name="Web Service Consumer Config" doc:id="3e49554b-3b1e-45d8-b3cf-f917648be5db" >
		<wsc:connection wsdlLocation="api\BestellungBeanService.wsdl" service="BestellungBeanService" port="BestellungBeanPort" address="${common-was.endpoint}/beschaffung-services-web/BestellungBeanService">
			<wsc:custom-transport-configuration >
				<wsc:default-http-transport-configuration timeout="200000" />
			</wsc:custom-transport-configuration>
			<wsc:web-service-security actor="http://schemas.xmlsoap.org/soap/actor/next" >
				<wsc:username-token-security-strategy username="${was.username}" password="${secure::was.password}" addNonce="true" addCreated="true" />
			</wsc:web-service-security>
		</wsc:connection>
	</wsc:config>
	<wsc:config name="ArbeitspaketeBean_Config" doc:name="Web Service Consumer Config" doc:id="b1319f34-d588-4fb5-9c8a-e34700413281" >
		<wsc:connection wsdlLocation="api\ArbeitspaketeBeanService.wsdl" service="ArbeitspaketeBeanService" port="ArbeitspaketeBeanPort" address="${common-was.endpoint}/logistikauftrag-services-web/ArbeitspaketeBeanService">
			<wsc:custom-transport-configuration >
				<wsc:default-http-transport-configuration timeout="200000" />
			</wsc:custom-transport-configuration>
			<wsc:web-service-security actor="http://schemas.xmlsoap.org/soap/actor/next" >
				<wsc:username-token-security-strategy username="${was.username}" password="${secure::was.password}" addNonce="true" addCreated="true" />
			</wsc:web-service-security>
		</wsc:connection>
	</wsc:config>
	<wsc:config name="MitarbeiterBean_Config" doc:name="Web Service Consumer Config" doc:id="d81e2bb9-2ad4-4d92-9432-d149f9952f4e" >
		<wsc:connection wsdlLocation="api\MitarbeiterBeanService.wsdl" service="MitarbeiterBeanService" port="MitarbeiterBeanPort" address="${common-was.endpoint}/HR_Stammdaten_EJBServices_Web_v2/MitarbeiterBeanService">
			<wsc:custom-transport-configuration >
				<wsc:default-http-transport-configuration timeout="200000" />
			</wsc:custom-transport-configuration>
			<wsc:web-service-security actor="http://schemas.xmlsoap.org/soap/actor/next" >
				<wsc:username-token-security-strategy username="${was.username}" password="${secure::was.password}" addNonce="true" addCreated="true" />
			</wsc:web-service-security>
		</wsc:connection>
	</wsc:config>
	<ee:object-store-caching-strategy name="orderInformation-caching-strategy"
		keyGenerationExpression='#["$(vars.wsRequest.getHVACStammdatenZuBestellung.mandant)_$(vars.wsRequest.getHVACStammdatenZuBestellung.bestellnummer)_$(vars.wsRequest.getHVACStammdatenZuBestellung.bestelljahr)"]' doc:name="orderInformation Caching Strategy">
	</ee:object-store-caching-strategy>
	<sub-flow name="hvac-unneeded-material-app-retrieve-unneeded-material-flow" doc:id="c3aaf2d3-ae7a-45c6-98a1-4cc76e3f8dd4">
		<ee:transform doc:name="prepare ws request" doc:id="6f05a9de-e50e-40f3-a442-c23960ea3a57">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable resource="mapping/retrieve_rohrteile.dwl" variableName="wsRequest" />
			</ee:variables>
		</ee:transform>
		<wsc:consume doc:name="ermittelnInaktiveRohrteileMitBestelldaten" doc:id="11f9412b-188c-4e1a-b557-ebe02f8a8d36" config-ref="RohrisometrieBean_Config" operation="ermittelnInaktiveRohrteileMitBestelldaten">
			<wsc:message>
				<wsc:body><![CDATA[#[vars.wsRequest]]]></wsc:body>
			</wsc:message>
		</wsc:consume>
		<logger level="DEBUG" doc:name="DEBUG retrieved payload" doc:id="85c8606e-f09b-4987-bd15-0d0920b1e1bd" message="#[&quot;Retrieved InaktiveRohrteileMitBestelldaten: &quot; ++ write(payload.body, 'application/xml')]" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
		<ee:transform doc:name="remove duplicates" doc:id="80b21dbb-0548-456a-a9f3-3b6e3469b46c">
			<ee:message>
				<ee:set-payload resource="mapping/rohrteile_remove_duplicates.dwl" />
			</ee:message>
		</ee:transform>
		<logger level="DEBUG" doc:name="DEBUG transformed payload" doc:id="1b3c3ad6-e79c-46db-ae3c-d2a677600025" message="#[&quot;InaktiveRohrteileMitBestelldaten without duplicates: &quot; ++ write(payload, 'application/xml')]" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
	</sub-flow>
</mule>
