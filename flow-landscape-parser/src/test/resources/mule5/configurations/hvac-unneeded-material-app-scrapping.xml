<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd">
	<sub-flow name="hvac-unneeded-material-app-scrapping-flow" doc:id="a31a8cbe-4933-42e3-9db1-befd8ce9788d" >
		<logger level="DEBUG" doc:name="DEBUG Start scrapping" doc:id="0114d204-8951-4c7e-aaf2-9f92c573cb7a" message="Start scrapping!" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
		<flow-ref doc:name="hvac-unneeded-material-app-scrapping-get-stock-information-flow" doc:id="da39c7ec-39b5-4b40-b728-a468c087e10f" name="hvac-unneeded-material-app-scrapping-get-stock-information-flow"/>
		<logger level="DEBUG" doc:name="DEBUG result" doc:id="a26d2b80-3c99-484a-8f01-b301223317f8" message="#[&quot;Collected stock information: &quot; ++ write(payload, 'application/json', {indent: false})]" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
		<choice doc:name="any parts found" doc:id="23ef236e-a507-4ba6-a817-6227afe0e3e5" >
			<when expression="#[not isEmpty(payload)]">
				<flow-ref doc:name="hvac-unneeded-material-app-scrapping-unneeded-material-flow" doc:id="d12e5852-f901-46df-be15-eada3ec9edf8" name="hvac-unneeded-material-app-scrapping-unneeded-material-flow"/>
			</when>
			<otherwise >
				<logger level="DEBUG" doc:name="DEBUG No parts found" doc:id="48065845-2e29-4ebf-a82a-164d420cab42" message="No unneeded material were found" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="hvac-unneeded-material-app-scrapping-unneeded-material-flow" doc:id="0559d5a6-fa3a-4f9e-8432-48ff3babbbf5" >
		<ee:transform doc:name="wsrequest" doc:id="91afa6b5-ff04-49e2-89ba-a9d3dc14a99a" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable resource="mapping/wsRequestScrapping.dwl" variableName="wsrequest" />
			</ee:variables>
		</ee:transform>
		<wsc:consume doc:name="erstellenVerschrottungsArbeitspaket" doc:id="5f10e390-07b5-438c-8595-ef2d9ad7bb26" config-ref="ArbeitspaketeBean_Config" operation="erstellenVerschrottungsArbeitspaket">
			<wsc:message >
				<wsc:body ><![CDATA[#[vars.wsrequest]]]></wsc:body>
			</wsc:message>
		</wsc:consume>
		<set-variable value="#[%dw 2.0&#10;output application/java&#10;ns ns0 http://arbeitspaket.materialwirtschaft.lv.meyerwerft.de/&#10;---&#10;not isEmpty(payload.body.ns0#erstellenVerschrottungsArbeitspaketResponse.return.positionen)]" doc:name="positionsNotEmpty" doc:id="c889ac55-4e05-40bf-95bc-bb3ab04ec033" variableName="positionsNotEmpty"/>
		<choice doc:name="positions available" doc:id="8bcdfa9d-95a6-4ba1-97ae-101e8c78e410" >
			<when expression="#[vars.positionsNotEmpty]">
				<logger level="DEBUG" doc:name="DEBUG positions found" doc:id="494e72f5-25f9-4c06-b5c6-2c9715d440a1" message="Positions were found" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
				<ee:transform doc:name="set status to VERSCHROTTET" doc:id="98210504-31e9-40d0-ba83-cbd3ce0752d4" >
					<ee:message >
					</ee:message>
					<ee:variables >
						<ee:set-variable resource="mapping/wsRequestStatusVerschrottet.dwl" variableName="wsrequest" />
					</ee:variables>
				</ee:transform>
				<wsc:consume operation="setzeTeileStatus" doc:name="set status" doc:id="3ef27958-8ba9-45a5-bfdb-80d624a70272" config-ref="RohrisometrieBean_Config" target="wsResponse">
					<wsc:message >
						<wsc:body ><![CDATA[#[vars.wsrequest]]]></wsc:body>
					</wsc:message>
				</wsc:consume>
			</when>
			<otherwise>
			<logger level="DEBUG" doc:name="DEBUG no positions" doc:id="9749773e-6883-455c-83a5-b9f6c810833d" message="No positions were found" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
			</otherwise>
		</choice>
		<ee:transform doc:name="prepare workpackage approval" doc:id="22ef6e47-f793-4d29-9d3b-92a655c7b655" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable resource="mapping/wsRequestFreigabe.dwl" variableName="wsrequest" />
			</ee:variables>
		</ee:transform>
		<wsc:consume operation="freigebenArbeitspaket" doc:name="approve workpackage" doc:id="4dd5575b-1b52-44e4-8990-1c2bf4150002" config-ref="ArbeitspaketeBean_Config">
			<wsc:message >
				<wsc:body ><![CDATA[#[vars.wsrequest]]]></wsc:body>
			</wsc:message>
		</wsc:consume>
	</sub-flow>
	<sub-flow name="hvac-unneeded-material-app-scrapping-get-stock-information-flow" doc:id="8f067d16-538d-48da-9f8e-e70a273b5ac7">
		<flow-ref doc:name="hvac-unneeded-material-app-retrieve-unneeded-material-flow" doc:id="ec361083-552f-49ba-bae2-8089cfe5d1bf" name="hvac-unneeded-material-app-retrieve-unneeded-material-flow"/>
		<choice doc:name="Choice unneded matieral found" doc:id="199d56e1-0c44-400c-a5b5-22dda7f3f3d8" >
			<when expression="#[not isEmpty(payload)]" >
				<logger level="INFO" doc:name="INFO Unneeded material found" doc:id="54ac524a-8c91-43d6-a6ed-423c8821809d" message="#[&quot;Found unneeded material: &quot; ++ write(payload, 'application/json', {indent: false})]" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
				<flow-ref doc:name="hvac-unneeded-material-app-scrapping-collect-stock-information-flow" doc:id="b088864e-9b26-4180-870d-d6f642e6e08c" name="hvac-unneeded-material-app-scrapping-collect-stock-information-flow"/>
			</when>
			<otherwise >
				<logger level="DEBUG" doc:name="DEBUG No unneeded material were found" doc:id="7fead56b-730e-4261-a2cd-f40dcda3e703" message="No unneeded material were found" category="de.meyerwerft.integration.hvac_unneededmaterial_app" />
				<set-payload value="#[[]]" doc:name="empty payload" doc:id="7c437cfa-9384-4bef-9c25-2e7537c7d7fc" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="hvac-unneeded-material-app-scrapping-collect-stock-information-flow" doc:id="3b5ed388-e611-43a7-965b-91f664b0a7eb" >
		<set-variable value="#[[]]" doc:name="stockInformation" doc:id="1afb9600-f269-47b1-b82e-c67a1b1a49d4" variableName="stockInformation"/>
		<foreach doc:name="For Each unneeded material" doc:id="f9ca3e83-17a4-4497-b8a6-7d90670ee542" collection="#[payload]" batchSize="50">
			<flow-ref doc:name="hvac-unneeded-material-app-scrapping-collect-stock-information-from-db-flow" doc:id="d1790f1d-3dbe-440e-a348-a7bd46f0f70a" name="hvac-unneeded-material-app-scrapping-collect-stock-information-from-db-flow" target="batchStockInformation"/>
			<ee:transform doc:name="match batchStockInformation with payload and join" doc:id="c5f89167-c95d-430f-8e92-0c4b0112e5c1">
				<ee:message>
					<ee:set-payload resource="mapping/determine_unneeded_material.dwl" />
				</ee:message>
			</ee:transform>
			<ee:transform doc:name="add payload to stockInformation" doc:id="94a0e7ea-9247-4a42-b386-a31e8bd1abb6" >
				<ee:message />
				<ee:variables >
					<ee:set-variable resource="mapping/addStockInformation.dwl" variableName="stockInformation" />
				</ee:variables>
			</ee:transform>
		</foreach>
		<logger level="INFO" doc:name="Logger" doc:id="7f85375c-4dd2-44a6-9304-bafe7b05a808" />
		<set-payload value="#[vars.stockInformation]" doc:name="set stockinformation as payload" doc:id="09ddb4c1-0801-41b0-8d7f-3ef7e5987f93" />
	</sub-flow>
	<sub-flow name="hvac-unneeded-material-app-scrapping-collect-stock-information-from-db-flow" doc:id="5b8edd8d-7a7c-4be5-95f3-103a351b9dbf" >
		<ee:transform doc:name="create query" doc:id="7d451bff-0513-4e1f-8822-a598be432a37">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable resource="mapping/createDbQuery.dwl" variableName="query" />
				</ee:variables>
			</ee:transform>
		<db:select doc:name="get stockinformation from db" doc:id="f046e4ec-8ee7-41da-a616-4a26e104a675" config-ref="common-as400-config">
				<db:sql><![CDATA[Select * from "jlmdatv5.pbestlo" :where]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	where: vars.query
}]]]></db:input-parameters>
			</db:select>
		<ee:transform doc:name="transform result to xml (batchStockInformation)" doc:id="a6f1fb9f-4235-4032-9a19-63fcaba2c948">
				<ee:message>
				<ee:set-payload resource="mapping/transformDbResult.dwl" />
				</ee:message>
				<ee:variables>
				</ee:variables>
			</ee:transform>
	</sub-flow>
</mule>
